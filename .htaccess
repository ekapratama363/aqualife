# ==========================
# 1️⃣ Proteksi File Sensitif
# ==========================
<FilesMatch "(\.env|\.git|\.htaccess|composer\.(json|lock)|phpunit\.xml|README\.md|LICENSE|spark|docker-compose\.yml|Dockerfile)">
    Require all denied
</FilesMatch>

# ==========================
# 2️⃣ Proteksi Folder Sensitif
# ==========================
RewriteEngine On

RewriteRule ^(application|system|vendor)/ - [F,L]

# Proteksi folder assets dan uploads, izinkan file gambar, CSS, JS, font, media, PDF, ZIP
RewriteCond %{REQUEST_URI} ^/(assets|uploads) [NC]
RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{REQUEST_URI} !\.(jpg|jpeg|png|gif|svg|webp|css|js|woff|woff2|ttf|eot|otf|mp4|mp3|webm|avi|mov|pdf|zip|rar)$ [NC]
RewriteRule .* - [F,L]

# Mencegah eksekusi file PHP di /uploads/ dan /assets/
RewriteRule ^(uploads|assets)/.*\.(php|php5|phtml)$ - [F,L]

# ==========================
# 3️⃣ Redirect Subdomain ke Folder
# ==========================
RewriteCond %{HTTP_HOST} ^cv\.akimotormobil\.com$ [NC]
RewriteCond %{REQUEST_URI} !^/cv/
RewriteRule ^(.*)$ /cv/$1 [L,QSA]

# ==========================
# 4️⃣ Aturan Default untuk CodeIgniter 3
# ==========================
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php/$1 [L]

# ==========================
# 5️⃣ Proteksi dari urlscan.io
# ==========================
RewriteCond %{HTTP_USER_AGENT} urlscan.io [NC]
RewriteRule .* - [F,L]

<IfModule mod_setenvif.c>
    SetEnvIfNoCase User-Agent "urlscan.io" bad_bot
</IfModule>

<IfModule mod_authz_core.c>
    <RequireAll>
        Require all granted
        Require not env bad_bot
    </RequireAll>
</IfModule>

# ==========================
# 6️⃣ Proteksi dari akses .git
# ==========================
RedirectMatch 404 /\.git

# ==========================
# 7️⃣ Optimasi Keamanan dengan Header
# ==========================
<IfModule mod_headers.c>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
</IfModule>

# ==========================
# 8️⃣ Optimasi Performa dengan Kompresi dan Cache
# ==========================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/css text/javascript application/javascript
</IfModule>

<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
</IfModule>